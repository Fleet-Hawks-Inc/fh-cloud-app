{"ast":null,"code":"import _asyncToGenerator from \"C:/FH/fh-cloud-app/node_modules/@angular-devkit/build-angular/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { MapInfoWindow } from '@angular/google-maps';\nimport { Subject } from 'rxjs';\nimport { takeUntil } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"src/app/services/dash-cam-location-stream.service\";\nimport * as i3 from \"src/app/services\";\nimport * as i4 from \"ngx-toastr\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"@angular/google-maps\";\n\nfunction LocationShareComponent_p_0_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\");\n    i0.ɵɵtext(1, \"Please wait loading....\");\n    i0.ɵɵelementEnd();\n  }\n}\n\nfunction LocationShareComponent_section_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r4 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"section\", 2);\n    i0.ɵɵelementStart(1, \"div\", 3);\n    i0.ɵɵelement(2, \"div\", 4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"div\", 3);\n    i0.ɵɵelement(4, \"div\", 5);\n    i0.ɵɵelementStart(5, \"div\", 6);\n    i0.ɵɵelementStart(6, \"h3\");\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"p\");\n    i0.ɵɵtext(9, \"Last Location: \");\n    i0.ɵɵelementStart(10, \"b\");\n    i0.ɵɵtext(11);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(12, \"google-map\", 7);\n    i0.ɵɵelement(13, \"map-traffic-layer\", 8);\n    i0.ɵɵelementStart(14, \"map-marker\", 9, 10);\n    i0.ɵɵlistener(\"mapClick\", function LocationShareComponent_section_1_Template_map_marker_mapClick_14_listener() {\n      i0.ɵɵrestoreView(_r4);\n\n      const _r2 = i0.ɵɵreference(15);\n\n      const ctx_r3 = i0.ɵɵnextContext();\n      return ctx_r3.openInfoWindow(_r2);\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(16, \"map-info-window\", 11);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(17, \"a\", 12);\n    i0.ɵɵelementStart(18, \"h3\", 13);\n    i0.ɵɵtext(19, \"Powered by Fleet Hawks Inc. \");\n    i0.ɵɵelement(20, \"i\", 14);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(21, \"div\", 5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(7);\n    i0.ɵɵtextInterpolate1(\"Truck : \", ctx_r1.apiResponse.vehicleName, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(ctx_r1.apiResponse.lastLocation);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"width\", ctx_r1.width)(\"height\", ctx_r1.height)(\"center\", ctx_r1.center)(\"options\", ctx_r1.mapOptions)(\"zoom\", ctx_r1.zoom);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"autoRefresh\", true);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"position\", ctx_r1.center)(\"options\", ctx_r1.vehicleMarkerOptions);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"innerHTML\", ctx_r1.infoDetail, i0.ɵɵsanitizeHtml);\n  }\n}\n\nexport class LocationShareComponent {\n  constructor(route, webSocket, apiService, toaster) {\n    this.route = route;\n    this.webSocket = webSocket;\n    this.apiService = apiService;\n    this.toaster = toaster;\n    this.lat = -104.618896;\n    this.lng = 50.44521;\n    this.width = \"100%\";\n    this.height = \"100%\";\n    this.zoom = 17;\n    this.center = {\n      lat: 48.48248695279594,\n      lng: -99.0688673798094\n    };\n    this.token = undefined;\n    this.loaded = false;\n    this.infoDetail = 'Vehicle is Offline!!';\n    this.vehicleMarkerOptions = {\n      draggable: false,\n      icon: 'assets/vehicle-marker.png'\n    };\n    this.mapOptions = {\n      center: this.center,\n      zoomControl: true,\n      mapTypeControl: true,\n      streetViewControl: true,\n      fullscreenControl: true,\n      zoom: 15,\n      mapId: '620eb1a41a9e36d4',\n      rotateControl: true,\n      clickableIcons: true\n    }; // this.overlays.push(position)\n\n    this.messages = [];\n    this.destroyed$ = new Subject();\n    this.token = this.route.snapshot.params.token;\n  }\n\n  ngOnInit() {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      // google.maps.geometry.spherical.computeHeading - for rotation of icon\n      _this.apiResponse = yield _this.validateAndGetLocation();\n\n      if (_this.apiResponse && _this.apiResponse.errorCode) {\n        _this.toaster.error('This link has expired.');\n\n        _this.loaded = false;\n      }\n\n      if (_this.apiResponse) {\n        _this.loaded = true;\n        _this.center = {\n          lat: _this.apiResponse.lng,\n          lng: _this.apiResponse.lat\n        };\n\n        _this.connectToWSServer();\n\n        _this.updateLastLocation();\n      }\n    })();\n  }\n\n  connectToWSServer() {\n    this.webSocket.connect(this.apiResponse.usage, this.apiResponse.salt, this.apiResponse.token).pipe(takeUntil(this.destroyed$)).subscribe(messages => {\n      if (messages.action === '80000') {\n        this.toaster.success('Successfully Connected to Server..');\n      }\n\n      if (messages.action === \"80003\" && messages.payload.deviceID === this.apiResponse.deviceID) {\n        this.messages.push(messages);\n\n        if (this.messages.length === 1) {\n          this.toaster.success('Vehicle is online...');\n        }\n\n        this.center = {\n          lat: parseFloat(messages.payload.location.latitude),\n          lng: parseFloat(messages.payload.location.longitude)\n        };\n        this.apiResponse.speed = parseFloat(messages.payload.location.speed).toFixed(2) || 0.0;\n        this.apiResponse.networkType = this.getNetwork(messages.payload.mobile.type);\n      }\n    });\n  }\n\n  updateLastLocation() {\n    var _this2 = this;\n\n    setInterval( /*#__PURE__*/_asyncToGenerator(function* () {\n      const response = yield _this2.validateAndGetLocation();\n\n      if (_this2.apiResponse && _this2.apiResponse.errorCode) {\n        _this2.toaster.error('This link has expired.');\n      }\n\n      if (response) {\n        _this2.apiResponse.lastLocation = response.lastLocation;\n      }\n    }), 60000);\n  }\n\n  validateAndGetLocation() {\n    var _this3 = this;\n\n    return _asyncToGenerator(function* () {\n      return yield _this3.apiService.getData(`location/share/get/${_this3.token}`).toPromise();\n    })();\n  }\n\n  ngOnDestroy() {\n    this.destroyed$.next();\n  }\n\n  openInfoWindow(marker) {\n    this.infoDetail = `<b>Vehicle Name : ${this.apiResponse.vehicleName}</b><br>`;\n\n    if (this.apiResponse.speed) {\n      this.infoDetail += `<b>Speed : ${this.apiResponse.speed} km/h</b><br>`;\n    }\n\n    if (this.apiResponse.networkType) {\n      this.infoDetail += `<b>Network : ${this.apiResponse.networkType}</b>`;\n    }\n\n    this.infoWindow.open(marker);\n  }\n\n  getNetwork(networkType) {\n    switch (networkType) {\n      case '-1':\n        return 'Offline';\n\n      case '0':\n        return 'Unknown';\n\n      case '3':\n        return '2G';\n\n      case '4':\n        return '3G';\n\n      case '5':\n        return '4G';\n\n      default:\n        return undefined;\n    }\n  }\n\n}\n\nLocationShareComponent.ɵfac = function LocationShareComponent_Factory(t) {\n  return new (t || LocationShareComponent)(i0.ɵɵdirectiveInject(i1.ActivatedRoute), i0.ɵɵdirectiveInject(i2.DashCamLocationStreamService), i0.ɵɵdirectiveInject(i3.ApiService), i0.ɵɵdirectiveInject(i4.ToastrService));\n};\n\nLocationShareComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: LocationShareComponent,\n  selectors: [[\"app-location-share\"]],\n  viewQuery: function LocationShareComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(MapInfoWindow, 5);\n    }\n\n    if (rf & 2) {\n      let _t;\n\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.infoWindow = _t.first);\n    }\n  },\n  decls: 2,\n  vars: 2,\n  consts: [[4, \"ngIf\"], [\"class\", \"body\", \"style\", \"background:white;height: 100%;color: black;\", \"class\", \"contianer-fluid\", 4, \"ngIf\"], [1, \"contianer-fluid\", 2, \"background\", \"white\", \"height\", \"100%\", \"color\", \"black\"], [1, \"row\"], [1, \"col-md-2\"], [1, \"col-md-1\"], [1, \"col-md-10\", 2, \"height\", \"70vh\", \"width\", \"100vh\"], [3, \"width\", \"height\", \"center\", \"options\", \"zoom\"], [3, \"autoRefresh\"], [3, \"position\", \"options\", \"mapClick\"], [\"marker\", \"mapMarker\"], [3, \"innerHTML\"], [\"href\", \"https://fleethawks.com\", \"target\", \"_blank\"], [1, \"pull-right\"], [1, \"fas\", \"fa-angle-double-right\"]],\n  template: function LocationShareComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵtemplate(0, LocationShareComponent_p_0_Template, 2, 0, \"p\", 0);\n      i0.ɵɵtemplate(1, LocationShareComponent_section_1_Template, 22, 11, \"section\", 1);\n    }\n\n    if (rf & 2) {\n      i0.ɵɵproperty(\"ngIf\", !ctx.loaded);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", ctx.loaded);\n    }\n  },\n  directives: [i5.NgIf, i6.GoogleMap, i6.MapTrafficLayer, i6.MapMarker, i6.MapInfoWindow],\n  styles: [\"\"]\n});","map":null,"metadata":{},"sourceType":"module"}