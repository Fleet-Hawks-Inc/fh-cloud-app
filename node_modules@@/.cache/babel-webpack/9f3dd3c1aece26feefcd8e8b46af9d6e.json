{"ast":null,"code":"import _asyncToGenerator from \"C:/FH/fh-cloud-app/node_modules/@angular-devkit/build-angular/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { __decorate } from \"tslib\";\nimport __NG_CLI_RESOURCE__0 from \"!C:\\\\FH\\\\fh-cloud-app\\\\node_modules\\\\@ngtools\\\\webpack\\\\src\\\\loaders\\\\direct-resource.js!./add-vendor-credit-note.component.html\";\nimport __NG_CLI_RESOURCE__1 from \"./add-vendor-credit-note.component.css\";\nimport { Component } from \"@angular/core\";\nimport { ActivatedRoute } from \"@angular/router\";\nimport * as moment from \"moment\";\nimport { ToastrService } from \"ngx-toastr\";\nimport { from } from \"rxjs\";\nimport { map } from \"rxjs/operators\";\nimport { AccountService, ListService } from \"src/app/services\";\nimport { Location } from \"@angular/common\";\nimport { HttpClient } from \"@angular/common/http\";\nlet AddVendorCreditNoteComponent = class AddVendorCreditNoteComponent {\n  constructor(listService, route, toaster, location, accountService, httpClient) {\n    this.listService = listService;\n    this.route = route;\n    this.toaster = toaster;\n    this.location = location;\n    this.accountService = accountService;\n    this.httpClient = httpClient;\n    this.submitDisabled = false;\n    this.total = 0;\n    this.creditData = {\n      txnDate: moment().format(\"YYYY-MM-DD\"),\n      currency: \"CAD\",\n      crRef: \"\",\n      purOrder: null,\n      vendorID: null,\n      crDetails: [{\n        commodity: \"\",\n        desc: \"\",\n        qty: 0,\n        qtyUnit: null,\n        rate: 0,\n        rateUnit: null,\n        amount: 0,\n        accountID: null\n      }],\n      remarks: \"\",\n      totalAmt: 0,\n      transactionLog: []\n    };\n    this.accounts = [];\n    this.vendors = [];\n    this.errors = {};\n    this.response = \"\";\n    this.hasError = false;\n    this.hasSuccess = false;\n    this.Error = \"\";\n    this.pageTitle = \"Add\";\n    this.units = [];\n    this.purchaseOrders = [];\n    this.filesError = '';\n    this.docs = [];\n    this.oldDocs = [];\n    this.removedDocs = [];\n  }\n\n  ngOnInit() {\n    this.creditID = this.route.snapshot.params[`creditID`];\n\n    if (this.creditID) {\n      this.pageTitle = \"Edit\";\n      this.fetchCredit();\n    } else {\n      this.pageTitle = \"Add\";\n    }\n\n    this.fetchAccounts();\n    this.fetchQuantityUnits();\n    this.listService.fetchVendors();\n    let vendorList = new Array();\n    this.getValidVendors(vendorList);\n    this.vendors = vendorList;\n  }\n\n  getValidVendors(vendorList) {\n    let ids = [];\n    this.listService.vendorList.forEach(element => {\n      element.forEach(element2 => {\n        if (element2.isDeleted === 0 && !ids.includes(element2.contactID)) {\n          vendorList.push(element2);\n          ids.push(element2.contactID);\n        }\n      });\n    });\n  }\n\n  refreshVendorData() {\n    this.listService.fetchVendors();\n  }\n\n  openModal(unit) {\n    this.listService.triggerModal(unit);\n    localStorage.setItem(\"isOpen\", \"true\");\n    this.listService.changeButton(false);\n  }\n\n  fetchQuantityUnits() {\n    this.httpClient.get(\"assets/jsonFiles/quantityTypes.json\").subscribe(data => {\n      this.units = data;\n    });\n  }\n\n  fetchAccounts() {\n    this.accountService.getData(`chartAc/fetch/list`).subscribe(res => {\n      this.accounts = res;\n    });\n  }\n\n  changeUnit(value, i) {\n    this.creditData.crDetails[i].qtyUnit = value;\n    this.creditData.crDetails[i].rateUnit = value;\n  }\n\n  addDetails() {\n    const lastInd = this.creditData.crDetails.length - 1;\n\n    if (this.creditData.crDetails[lastInd].commodity !== \"\" && this.creditData.crDetails[lastInd].qty > 0 && this.creditData.crDetails[lastInd].qtyUnit != null && this.creditData.crDetails[lastInd].rateUnit != null && this.creditData.crDetails[lastInd].rate > 0 && this.creditData.crDetails[lastInd].accountID != null) {\n      this.creditData.crDetails.push({\n        commodity: \"\",\n        desc: \"\",\n        qty: 0,\n        qtyUnit: null,\n        rate: 0,\n        rateUnit: null,\n        amount: 0,\n        accountID: null\n      });\n    }\n  }\n\n  deleteDetail(d) {\n    this.total -= this.creditData.crDetails[d].amount;\n    this.creditData.crDetails.splice(d, 1);\n  }\n\n  calculateAmount(i) {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      let total = 0;\n      let amount = _this.creditData.crDetails[i].qty * _this.creditData.crDetails[i].rate;\n      _this.creditData.crDetails[i].amount = parseFloat(amount.toFixed(2));\n\n      _this.creditData.crDetails.forEach(element => {\n        total += element.amount;\n      });\n\n      _this.total = total;\n    })();\n  }\n\n  cancel() {\n    this.location.back(); // <-- go back to previous location on cancel\n  }\n\n  addNotes() {\n    for (let i = 0; i < this.creditData.crDetails.length; i++) {\n      const element = this.creditData.crDetails[i];\n\n      if (element.commodity === \"\" || element.qty <= 0 || element.qtyUnit === null || element.rateUnit == null || element.rate <= 0 || element.accountID === null) {\n        this.toaster.error(\"Please enter valid credit details\");\n        return false;\n      }\n    }\n\n    this.submitDisabled = true;\n    this.creditData.totalAmt = this.total; // create form data instance\n\n    const formData = new FormData(); //append docs if any\n\n    for (let j = 0; j < this.docs.length; j++) {\n      formData.append(\"docs\", this.docs[j]);\n    } //append other fields\n\n\n    formData.append(\"data\", JSON.stringify(this.creditData));\n    this.accountService.postData(`vendor-credits`, formData, true).subscribe({\n      complete: () => {},\n      error: err => {\n        this.submitDisabled = false;\n        from(err.error).pipe(map(val => {\n          val.message = val.message.replace(/\".*\"/, \"This Field\");\n          this.errors[val.context.key] = val.message;\n        })).subscribe({\n          complete: () => {\n            this.submitDisabled = false; // this.throwErrors();\n          },\n          error: () => {// this.submitDisabled = false;\n          },\n          next: () => {}\n        });\n      },\n      next: res => {\n        this.submitDisabled = false;\n        this.response = res;\n        this.toaster.success(\"Credit note added successfully.\");\n        this.cancel();\n      }\n    });\n  }\n\n  fetchCredit() {\n    this.accountService.getData(`vendor-credits/detail/${this.creditID}`).subscribe(res => {\n      let result = res[0];\n      this.creditData.purOrder = result.purOrder;\n      this.creditData.currency = result.currency;\n      this.creditData.crRef = result.crRef;\n      this.creditData.txnDate = result.txnDate;\n      this.creditData.vCrNo = result.vCrNo;\n      this.creditData.vendorID = result.vendorID;\n      this.creditData.crDetails = result.crDetails;\n      this.creditData.remarks = result.remarks;\n      this.creditData.docs = result.docs;\n      this.total = result.totalAmt;\n\n      if (result.docs && result.docs.length > 0) {\n        result.docs.forEach(x => {\n          let obj = {};\n\n          if (x.storedName.split(\".\")[1] === \"jpg\" || x.storedName.split(\".\")[1] === \"png\" || x.storedName.split(\".\")[1] === \"jpeg\") {\n            obj = {\n              imgPath: `${x.urlPath}`,\n              docPath: `${x.urlPath}`,\n              displayName: x.displayName,\n              name: x.storedName,\n              ext: x.storedName.split(\".\")[1]\n            };\n          } else {\n            obj = {\n              imgPath: \"assets/img/icon-pdf.png\",\n              docPath: `${x.urlPath}`,\n              displayName: x.displayName,\n              name: x.storedName,\n              ext: x.storedName.split(\".\")[1]\n            };\n          }\n\n          this.oldDocs.push(obj);\n        });\n      }\n\n      this.fetchPurchaseOrders();\n    });\n  }\n\n  updateNotes() {\n    this.submitDisabled = true;\n    this.creditData.totalAmt = this.total;\n    this.creditData.removedDocs = this.removedDocs; // create form data instance\n\n    const formData = new FormData(); //append docs if any\n\n    for (let j = 0; j < this.docs.length; j++) {\n      formData.append(\"docs\", this.docs[j]);\n    } //append other fields\n\n\n    formData.append(\"data\", JSON.stringify(this.creditData));\n    this.accountService.putData(`vendor-credits/update/${this.creditID}`, formData, true).subscribe({\n      complete: () => {},\n      error: err => {\n        this.submitDisabled = false;\n        from(err.error).pipe(map(val => {\n          val.message = val.message.replace(/\".*\"/, \"This Field\");\n          this.errors[val.context.key] = val.message;\n        })).subscribe({\n          complete: () => {//this.submitDisabled = false;\n            // this.throwErrors();\n          },\n          error: () => {// this.submitDisabled = false;\n          },\n          next: () => {}\n        });\n      },\n      next: res => {\n        // this.submitDisabled = false;\n        this.response = res;\n        this.toaster.success(\"Credit note updated successfully.\");\n        this.cancel();\n      }\n    });\n  }\n\n  fetchPurchaseOrders() {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      _this2.purchaseOrders = [];\n\n      if (_this2.creditData.vendorID) {\n        let result = yield _this2.accountService.getData(`purchase-orders/vendor/all/${_this2.creditData.vendorID}`).toPromise();\n        _this2.purchaseOrders = result;\n      }\n    })();\n  }\n\n  uploadDocs(documents) {\n    this.filesError = '';\n    this.docs = [];\n    let files = [...documents];\n    let filesSize = 0;\n\n    if (files.length > 5) {\n      this.toaster.error(\"Files count limit exceeded\");\n      this.filesError = \"Files should not be more than 5\";\n      return;\n    }\n\n    for (let i = 0; i < files.length; i++) {\n      filesSize += files[i].size / 1024 / 1024;\n\n      if (filesSize > 10) {\n        this.toaster.error(\"Files size limit exceeded\");\n        this.filesError = 'Files size limit exceeded. Files size should be less than 10mb';\n        return;\n      } else {\n        let name = files[i].name.split(\".\");\n        let ext = name[name.length - 1].toLowerCase();\n\n        if (ext == \"doc\" || ext == \"docx\" || ext == \"pdf\" || ext == \"jpg\" || ext == \"jpeg\" || ext == \"png\") {\n          this.docs.push(files[i]);\n        } else {\n          this.filesError = \"Only .doc, .docx, .pdf, .jpg, .jpeg and png files allowed.\";\n        }\n      }\n    }\n  }\n\n  deleteDocument(name, index) {\n    this.oldDocs.filter(elem => {\n      if (elem.displayName === name) {\n        let obj = {\n          storedName: elem.name,\n          displayName: elem.displayName\n        };\n        this.removedDocs.push(obj);\n        ;\n      }\n    });\n    this.oldDocs.splice(index, 1);\n  }\n\n};\n\nAddVendorCreditNoteComponent.ctorParameters = () => [{\n  type: ListService\n}, {\n  type: ActivatedRoute\n}, {\n  type: ToastrService\n}, {\n  type: Location\n}, {\n  type: AccountService\n}, {\n  type: HttpClient\n}];\n\nAddVendorCreditNoteComponent = __decorate([Component({\n  selector: \"app-add-vendor-credit-note\",\n  template: __NG_CLI_RESOURCE__0,\n  styles: [__NG_CLI_RESOURCE__1]\n})], AddVendorCreditNoteComponent);\nexport { AddVendorCreditNoteComponent };","map":null,"metadata":{},"sourceType":"module"}