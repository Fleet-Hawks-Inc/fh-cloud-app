
<html>

    <head>
        <title>Crop and batch process test</title>
        <style>
            canvas {
                border: dotted gray 2px;
                margin: 20px;
            }
        </style>
       <script src="//mozilla.github.io/pdf.js/build/pdf.js">
       </script>

       <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <body>
          <h1>Upload</h1> 
          
          <!-- <input name="userfile" src="" type="file" accept="application/pdf, application/vnd.ms-excel" id="pdffile"/>
           -->
           <input type="file" id="myFile" size="50">
        <canvas id="src" width="1000", height="1000"></canvas>
        
        <h1 id="a"></h1>

        <!-- Button trigger modal -->


<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" >
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <select class="form-control">
            <option>Id</option>
            <option>Trailer no.</option>
            <option>Email</option>
          </select>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <input type="text" id="text" name="country" value=""><br><br>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>




        
    
        
        <script src='https://unpkg.com/tesseract.js@v2.0.0-alpha.10/dist/tesseract.min.js'></script>

    
    
    
        
    
    
        <script>
            var canvas = document.getElementById('src');
            var pdffile = document.getElementById('pdffile');
            var el = document.getElementById('myFile');
    
            
            var ctx = canvas.getContext('2d');
            var rect = {};
            var drag = false;
            var imageObj = null;
            var renderTask;
            
    
    
            el.onchange = function(){ 
                // var url = document.getElementById("myFile").value;
                var url ="demo1.pdf"
                // Loaded via <script> tag, create shortcut to access PDF.js exports.
                var pdfjsLib = window['pdfjs-dist/build/pdf'];
    
                // The workerSrc property shall be specified.
                pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';
    
                var loadingTask = pdfjsLib.getDocument(url);
                loadingTask.promise.then(function(pdf) {
                console.log('PDF loaded');
                
                // Fetch the first page
                var pageNumber = 1;
                pdf.getPage(pageNumber).then(function(page) {
                    console.log('Page loaded');
                    
                    var scale = 1.5;
                    var viewport = page.getViewport({scale: scale});
    
                    // Prepare canvas using PDF page dimensions
                    var canvas = document.getElementById('src');
                    var context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
    
                    // Render PDF page into canvas context
                    var renderContext = {
                    canvasContext: context,
                    viewport: viewport
                    };
                     renderTask = page.render(renderContext);
                    renderTask.promise.then(function () {
                    console.log('Page rendered');
                    });
                });
                }, function (reason) {
                // PDF loading error
                console.error(reason);
                });
            }
            // var ocrJson = {
            //     // todo: other parameters. b&w, resizing strategy etc
            //     "version": "1.0.0",
            //     "schema": "My OCR Meta JSON",
            //     "rectangles": [
            //         { "left": 70, "top": 95, "width": 130, "height": 15, "label": "PatientName" },
            //         { "left": 70, "top": 110, "width": 230, "height": 15, "label": "Address" },
            //         { "left": 140, "top": 135, "width": 150, "height": 15, "label": "DOS" },
            //     ],
            // };
            
    
            async function loadImage(url) {
                return new Promise(r => { let i = new Image(); i.onload = (() => r(i)); i.src = url; });
            }
          
            // todo, add parameters and change sourceImage to ImageData (getImageData from other canvas)
            function cropImage(sourceImage, rect) {
                // parameterize them
                var left = rect.left;
                var top = rect.top;
                var width = rect.width;
                var height = rect.height;
    
                var cropCanvas = document.createElement('canvas');
                cropCanvas.width = width;
                cropCanvas.height = height;
    
                var context = cropCanvas.getContext('2d');
                context.drawImage(sourceImage, left, top, width, height, 0, 0, width, height);
                return cropCanvas;
            }
            function mouseDown(e) {
            rect.startX = e.pageX - this.offsetLeft;
            rect.startY = e.pageY - this.offsetTop;
            console.log(rect.startX)
         
            drag = true;
        
            
          }
          function mouseMove(e) {
            if (drag) {
                
                
                
                rect.w = (e.pageX - this.offsetLeft) - rect.startX;
                rect.h = (e.pageY - this.offsetTop) - rect.startY;
               
                ctx.strokeStyle = 'red';
                // ctx.strokeRect(rect.startX, rect.startY, rect.w, rect.h);
               
                
                
                
            }
            
            
        }
        async function mouseUp() {
            
            drag=false;
            
            ctx.strokeRect(rect.startX, rect.startY, rect.w, rect.h);
            
            console.log("mouseup working")
            console.log(rect.startX, rect.startY, rect.w, rect.h)
    
                
                var canvas = document.getElementById('src');
                
                
                const worker = new Tesseract.TesseractWorker();
                var srcContext = document.getElementById('src').getContext('2d');
               
                // let img = await loadImage('1.jpg');
                // srcContext.drawImage(img, 0, 0);
    
    
    
                var rct = { left: rect.startX, top: rect.startY, width: rect.w, height: rect.h };
                console.log("rct"+rct);
                    var cropImgCanvas = cropImage(canvas, rct);//img
    
                    // just renderint to visualize - no need for actual crop
                   
                    srcContext.rect(rct.left, rct.top, rct.width, rct.height);
                    srcContext.strokeStyle = "#FF0000";
                    srcContext.stroke();
    
                    // todo: pass the rect info and promise them all?
                    worker.recognize(cropImgCanvas)
                        .progress(progress => {
                            //console.log('progress:', progress);
                        }).then(result => {
                            console.log('result:', result.text);
                            document.getElementById("text").value = result.text;
                        });
                        $('#exampleModal').modal('show')
                        

                        
                
           
    
            
            
        }
            
             async function init() {
                // var drag = false;
                // var canvas = document.getElementById('src');
                
                
                // const worker = new Tesseract.TesseractWorker();
                // var srcContext = document.getElementById('src').getContext('2d');
                // var destContext = document.getElementById('dest').getContext('2d');
                // let img = await loadImage('1.jpg');
                // srcContext.drawImage(img, 0, 0);
    
                   canvas.addEventListener('mousedown', mouseDown, false);
                    canvas.addEventListener('mouseup', mouseUp, false);
                    canvas.addEventListener('mousemove', mouseMove, false);
                    
                   
                    
                    // var rect = { left: 70, top: 160, width: 70, height: 64 };
                    // var cropImgCanvas = cropImage(img, rect);
    
                    // // just renderint to visualize - no need for actual crop
                    // destContext.drawImage(cropImgCanvas, rect.left, rect.top);
                    // srcContext.rect(rect.left, rect.top, rect.width, rect.height);
                    // srcContext.strokeStyle = "#FF0000";
                    // srcContext.stroke();
    
                    // // todo: pass the rect info and promise them all?
                    // worker.recognize(cropImgCanvas)
                    //     .progress(progress => {
                    //         //console.log('progress:', progress);
                    //     }).then(result => {
                    //         console.log('result:', result.text);
                    //     });
                
           
                    
                // canvas.addEventListener('mouseup', mouseUp, false);
                // canvas.addEventListener('mousemove', mouseMove, false);
            }
            
            
            
    
            document.body.onload = init;
        </script>
        </head>
    </body>
    
    </html>