<style>
  .extra {
    display: none;
  }
</style>
<section class="body">
  <div class="inner-wrapper">
    <section role="main" class="content-body pl-1 pt-0 pr-0">
      <header class="page-header flex align-items-center justify-content-start">
        <form class="formgrid grid">
          <div class="row">
            <div class="col" style="margin-left: 20px;margin-top: 5px;">
              <div class="row" style="padding-top: 9px">
                <div class="col-md-2 col-lg-2 pr-1">
                  <ng-select [(ngModel)]="orderFiltr.category" name="category" placeholder="Search by Category"
                    (change)="categoryChange($event)">
                    <ng-option *ngFor="let data of categoryFilter" value="{{
                      data.value }}">
                      {{ data.name }}</ng-option>
                  </ng-select>
                </div>

                <div class="col-md-2 col-lg-2 pr-1">
                  <div class="input-group input-group-md mb-3" *ngIf="orderFiltr.category
                    != 'customer' &&
                    orderFiltr.category != 'orderType' &&
                    orderFiltr.category != 'orderStatus'">
                    <input type="text" class="form-control" name="searchValue" [(ngModel)]="orderFiltr.searchValue"
                      placeholder="Search" />
                  </div>

                  <ng-select [(ngModel)]="orderFiltr.searchValue" name="searchValue" placeholder="Search By
                    Customer" *ngIf="orderFiltr.category == 'customer'">
                    <ng-option *ngFor="let data of customersObjects | keyvalue" value="{{ data.key }}">
                      {{ data.value }}</ng-option>
                  </ng-select>

                  <ng-select [(ngModel)]="orderFiltr.searchValue" name="searchValue" placeholder="Search By Order
                    Status" *ngIf="orderFiltr.category == 'orderStatus'">
                    <ng-option *ngFor="let data of statusData" value="{{ data.value
                      }}">
                      {{ data.name }}</ng-option>
                  </ng-select>

                  <ng-select [(ngModel)]="orderFiltr.searchValue" name="searchValue" placeholder="Search By Order
                    Type" *ngIf="orderFiltr.category == 'orderType'">
                    <ng-option value="FTL"> FTL</ng-option>
                    <ng-option value="LTL"> LTL</ng-option>
                  </ng-select>
                </div>

                <div class="col-lg-3 col-md-3 pr-1">
                  <div class="input-daterange input-group">
                    <span class="input-group-prepend">
                      <span class="input-group-text">
                        <i class="fas fa-calendar-alt"></i>
                      </span>
                    </span>
                    <input [(ngModel)]="orderFiltr.startDate" name="fromDate" type="text" placeholder="yyyy/mm/dd"
                      (click)="from.toggle()" ngbDatepicker #from="ngbDatepicker" class="form-control"
                      autocomplete="off" [minDate]="dateMinLimit" [maxDate]="futureDatesLimit" />
                    <span class="input-group-text
                      border-left-0 border-right-0
                      rounded-0">
                      to
                    </span>
                    <input [(ngModel)]="orderFiltr.endDate" name="toDate" type="text" placeholder="yyyy/mm/dd"
                      (click)="to.toggle()" ngbDatepicker #to="ngbDatepicker" class="form-control" autocomplete="off"
                      [minDate]="dateMinLimit" [maxDate]="futureDatesLimit" />
                  </div>
                </div>

                <div class="col-md-2 col-lg-2">
                  <button type="submit" class="btn btn-sm btn-success mr-3" [disabled]="isSearch"
                    (click)="filterOrders()">
                    Search
                  </button>
                  <button type="submit" class="btn btn-sm btn-success" [disabled]="isSearch" (click)="resetFilter()">
                    Reset
                  </button>
                </div>

              </div>
            </div>
          </div>
        </form>
      </header>
      <section class="m-2">
        <div class="row mb-3">
          <div class="col-lg-12">
            <div class="bg-white p-3 text-dark text-capitalize">
              <div class="form-group row pt-3">
                <div class="col-lg-12" style="height: calc(100vh - 149px); overflow-y: scroll;">
                  <p-table #dt [value]="orders" [resizableColumns]="true" columnResizeMode="expand"
                    scrollDirection="both" [columns]="selectedColumns" [loading]="!loaded"
                    styleClass=" p-datatable-md p-datatable-gridlines p-datatable-striped" [scrollable]="true"
                    [loading]="!loaded" scrollHeight="100%" dataKey="orderNumber" responsiveLayout="scroll">


                    <ng-template pTemplate="caption">
                      <div class="p-d-flex d-flex justify-content-between align-items-center">
                        <div>
                          <h3 class="m-0"> Orders </h3>
                        </div>
                        <div class="text-right">
                          <span>Showing {{orders.length}} enteries</span> &nbsp;
                          <button type="button" pButton (click)="refreshData()" pTooltip="Refresh"
                            class="p-button-outlined mr-2" icon="fas fa-sync"></button>

                          <button type="button" pButton pTooltip="Add" routerLink="/dispatch/orders/add"
                            class="p-button-outlined mr-2" icon="pi pi-plus"></button>

                          <button pButton pRipple pTooltip="Clear Filter" class="p-button-outlined mr-2"
                            (click)="clear(dt)" icon="pi pi-filter-slash"></button>

                          <button type="button" pButton pRipple class="p-button-outlined mr-2"
                            icon="fas fa-regular fa-file-excel" (click)="dt.exportCSV()" pTooltip="Excel"></button>

                        </div>
                      </div>
                    </ng-template>

                    <!-- Header template of DataTable -->
                    <ng-template pTemplate="header" let-columns>
                      <tr>


                        <th *ngFor="let column of dataColumns" [pSortableColumn]="column.field" pResizableColumn
                          [ngStyle]="{'width': column.width}">
                          <span>
                            <div class="flex justify-content-center align-items-center" alignFrozen="right"
                              pFrozenColumn [frozen]="true">
                              {{column.header}}
                              <p-sortIcon [field]="column.field" [hidden]="column.field === 'invStatus'">
                              </p-sortIcon>
                              <p-columnFilter [type]="column.type" [field]="column.field" matchMode="contains"
                                [showMatchModes]="false" [hidden]="column.field === 'invStatus'" [showOperator]="false"
                                [showAddButton]="false" display="menu">
                              </p-columnFilter>
                            </div>
                          </span>

                        </th>
                        <th style="width: 7%" alignFrozen="right" pFrozenColumn [frozen]="true">Actions</th>
                      </tr>

                    </ng-template>
                    <ng-template pTemplate="body" let-order let-columns="columns" let-rowIndex="rowIndex"
                      let-expanded="expanded">
                      <tr style="cursor: pointer;">

                        <td routerLink='/dispatch/orders/detail/{{order.orderID}}' style="width:7%"
                          class="font-weight-bold">
                          {{order.orderNumber}}
                        </td>
                        <td routerLink='/dispatch/orders/detail/{{order.orderID}}' style="width:6%">
                          {{order.orderMode}}
                        </td>
                        <td routerLink='/dispatch/orders/detail/{{order.orderID}}' style="width:8%">
                          {{ order.createdDate | date: "yyyy/MM/dd" }}
                        </td>
                        <td routerLink='/dispatch/orders/detail/{{order.orderID}}' style="width:9%">
                          <div style="white-space: pre-line;">
                            {{order.customerData}}

                          </div>
                        </td>
                        <td routerLink='/dispatch/orders/detail/{{order.orderID}}' style="width:14%">
                          <div style="white-space: pre-line;">
                            {{order.pickupLocData}}

                          </div>
                        </td>

                        <td routerLink='/dispatch/orders/detail/{{order.orderID}}' style="width:14%">
                          <div style="white-space: pre-line;">
                            {{order.dropLocData}}

                          </div>
                        </td>
                        <td routerLink='/dispatch/orders/detail/{{order.orderID}}'
                          style="width:9%; white-space: pre-line">
                          {{order.commodityData}}

                        </td>
                        <td routerLink='/dispatch/orders/detail/{{order.orderID}}' style="width:8%">
                          {{ order.amount }}
                          <br />
                        </td>
                        <td routerLink='/dispatch/orders/detail/{{order.orderID}}' style="width:7%">
                          <div class="badges ">
                            <b>Invoiced: </b>
                            <span class="badge badge-success" *ngIf="order.invoicedTime"><i
                                class="fa fa-check"></i></span>
                            <span style="background: #000000a1;" class="badge badge-info" *ngIf="!order.invoicedTime"><i
                                class="fa fa-close"></i></span><br>
                            <b>Payment:</b> {{order.invStatus ? order.invStatus.replace('_', ' ') : 'NA'}}
                          </div>
                        </td>

                        <td routerLink='/dispatch/orders/detail/{{order.orderID}}' style="width:10%">
                          <span class="badge badge-dark p-1">{{ order.newStatus }}</span> <br>
                        </td>
                        <td style="width:7%;overflow: inherit !important; " pFrozenColumn alignFrozen="right"
                          [frozen]="true">
                          <div class="dropdown dropright" style="z-index: 1000">
                            <button class="bg-transparent border-0" type="button" id="dropdownMenuButton-{{rowIndex
                              }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="dropdown-menu" attr.aria-labelledby="dropdownMenuButton-{{
                           rowIndex
                              }}">
                              <a *ngIf="order.orderStatus!= 'delivered'" class="dropdown-item" routerLink="/dispatch/orders/edit/{{
                                order.orderID
                                }}">Edit</a>
                              <a *ngIf="order.orderStatus === 'confirmed'" class="dropdown-item"
                                [routerLink]="['/dispatch','trips','add-trip']"
                                [queryParams]="{orderId:order.orderID,orderNum:order.orderNumber}">Create Trip</a>
                              <a *ngIf="order.orderStatus == 'created' ||
                                order.orderStatus == 'confirmed'" class="dropdown-item" href="javascript:;"
                                (click)="deactivateOrder(order)">Delete</a>
                              <a *ngIf="order.orderStatus === 'created'" class="dropdown-item"
                                (click)="confirmEmail(order,rowIndex)">Confirm</a>
                              <a *ngIf="order.orderStatus === 'created' ||
                                order.orderStatus === 'confirmed'" class="dropdown-item" (click)="showBrokerageModal(
                                order,
                                ordersDraw,
                                rowIndex,
                                'all'
                                )">Brokerage</a>
                              <a *ngIf="order.orderStatus === 'brokerage'" class="dropdown-item" (click)="updateCreatedStatus(order,
                                ordersDraw, rowIndex)">Cancel Brokerage</a>
                              <a class="dropdown-item" [routerLink]="[
                                '/dispatch',
                                'orders',
                                'add'
                                ]" [queryParams]="{
                                cloneID: order.orderID
                                }">Clone</a>
                              <a *ngIf="order.canRecall" class="dropdown-item" routerLink="/dispatch/orders/edit/{{
                                order.orderID
                                }}" [queryParams]="{
                                state: 'recall'
                                }">Recall</a>
                            </div>
                          </div>
                        </td>
                      </tr>

                    </ng-template>

                    <!-- Empty Template -->
                    <ng-template pTemplate="emptymessage" let-columns>
                      <div class="col-lg-12 mt-3 text-center">
                        {{dataMessage}}
                        <br /><br>
                      </div>
                    </ng-template>
                    <!-- Summary Section with Load More button -->

                    <ng-template pTemplate="summary" let-columns>
                      <div class="col-lg-12 mt-3 text-center " *ngIf="lastEvaluatedKey !=='end' && orders.length !==0 ">
                        <button type="button " (click)="onScroll($event) "
                          class="btn btn-success btn-sm text-light ">Load
                          More..</button>

                        <br /><br>
                      </div>
                      <div class="col-lg-12 mt-3 text-center" *ngIf="lastEvaluatedKey ==='end'">
                        Total Records: {{orders.length}}</div>
                    </ng-template>


                  </p-table>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>


    </section>
  </div>
</section>

<div class="modal fade" id="orderStatusModal" role="dialog" tabindex="-1">
  <div class="modal-dialog" role="document" style="max-width: 500px">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Brokerage Order</h4>
        <button type="button" class="close" data-dismiss="modal">
          &times;
        </button>
      </div>
      <form>
        <div class="modal-body">
          <div class="form-group row text-dark">
            <div class="col-lg-12">
              <div class="row">
                <div class="col-lg-12">
                  <label class="control-label font-weight-bold text-lg-right
                    pt-2">Order Information</label>
                  <p>
                    Order# : {{ brokerage.orderNo }} <br />
                    Order Total: {{ brokerage.finalAmount }}
                  </p>
                </div>
                <div class="col-lg-12">
                  <div class="row">
                    <div class="col-lg-6">
                      <label class="control-label
                        font-weight-bold
                        text-lg-right
                        pt-2">Select Carrier</label>
                      <ng-select [(ngModel)]="brokerage.carrierID" name="brokerage.carrierID"
                        placeholder="Select Carrier">
                        <ng-option value="{{ data.key }}" *ngFor="let data of
                          carriersObject | keyvalue">
                          {{ data.value }}</ng-option>
                      </ng-select>
                    </div>
                    <div class="col-lg-6">
                      <label class="control-label
                        font-weight-bold
                        text-lg-right
                        pt-2">Brokerage amount</label>
                      <input [(ngModel)]="brokerage.brokerageAmount" name="brokerageAmount" type="text"
                        class="form-control" placeholder="e.g. 230" />
                    </div>
                  </div>
                </div>
                <div class="col-lg-12">
                  <label class="control-label font-weight-bold text-lg-right
                    pt-2">Special Instructions</label>
                  <textarea placeholder="eg.
                    Please be on time" [(ngModel)]="brokerage.instructions" name="instructions_br"
                    class="form-control h-auto" rows="2" pattern="^[\s\S]{500}$"></textarea>

                  <label class="error">{{ brokerErr }}</label>
                </div>

              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">
            Close
          </button>
          <button type="button" class="btn btn-success" [disabled]="brokerageDisabled" (click)="submitClick()">
            Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<app-brokerage-pdf></app-brokerage-pdf>

<ng-template #confirmEmailModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">
      Confirm Order <strong>#{{ newOrderNumber }}</strong>
    </h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <form>
    <div class="modal-body">
      <div class="email--invoice__main mt-3">
        <div class="row align-items-center mb-2">
          <div class="col-7">
            <label class="control-label font-weight-bold text-3 text-dark" for="inputDefault">Do you want to send the
              confirmation email to customer ?</label>
          </div>
          <div class="col-5">
            <div class="btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-outline btn-yesno mr-2 mb-2" [class.active]="emailData.confirmEmail === true"
                (click)="conEmailChange(true)">
                <input type="radio" [(ngModel)]="emailData.confirmEmail" name="orderMode" checked hidden value="FTL" />
                Yes
              </label>
              <label class="btn btn-outline btn-yesno mr-2 mb-2" [class.active]="emailData.confirmEmail === false"
                (click)="conEmailChange(false)">
                <input type="radio" [(ngModel)]="emailData.confirmEmail" name="orderMode" hidden value="LTL" />
                No
              </label>
            </div>
          </div>
        </div>
        <div class="" *ngIf="emailData.confirmEmail != false">
          <label class="control-label font-weight-bold mt-2 text-3 text-dark" for="inputDefault">Enter Email
            <small>You can also add multiple email(s)</small></label>
          <ng-select multiple="true" notFoundText="Please type to add
            email" [addTag]="true" placeholder="eg. johnsmith@gmail.com" [clearable]="false"
            [(ngModel)]="emailData.emails" name="emails" type="text" class="form-control h-auto"></ng-select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" (click)="modal.dismiss('Cross click')" class="btn
        btn-default">
        Cancel
      </button>
      <button [disabled]="isConfirm" (click)="changeStatus()" class="btn
        btn-success">
        Confirm
      </button>
    </div>
  </form>
</ng-template>