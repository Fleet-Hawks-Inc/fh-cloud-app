<section class="body">
    <div class="inner-wrapper">
        <section role="main" class="content-body pl-0 pr-0 pt-0">
            <header class="page-header">
                <h2>Payment</h2>
                <div class="right-wrapper text-right">

                    <div class="pull-right pr-2">
                        <a routerLink="/accounts/payments/employee-payments/list"
                            class="mb-1 mt-1 mr-1 mr-5 btn btn-default"><i class="fas fa-list"></i> All Payments</a>
                    </div>
                </div>
            </header>
            <section class="card mt-0 mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col pr-0">
                            <div class="card-body text-dark">
                                <form class="form-horizontal form-bordered" method="get" #empPaymentForm="ngForm">
                                    <div class="row">
                                        <div class="col-lg-5 offset-lg-1">
                                            <div class="row" id="settlementListDiv"> 
                                                <div class="col-lg-10">
                                                    <label
                                                        class="control-label font-weight-bold font-bold text-lg-right pt-2">Select Employee
                                                        <span class="mandfield text-2 ml-1"><sup>*</sup></span>
                                                    </label>
                                                    <ng-select [(ngModel)]="paymentData.entityId" name="type"
                                                        placeholder="Select Employee" (change)="fetchEmployeDetail()" [disabled]="submitDisabled" #empID="ngModel" required>
                                                        <ng-option value="{{ data.key }}"
                                                            *ngFor="let data of employees | keyvalue">{{ data.value }}
                                                        </ng-option>
                                                    </ng-select>

                                                    <div *ngIf="empID.invalid && (empID.dirty || empID.touched)" class="text-danger">
                                                        <div *ngIf="empID.errors.required">
                                                            Employee is required.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-5">
                                            <div class="row" id="settlementListDiv">
                                                <div class="col-lg-10">
                                                    <label
                                                        class="control-label font-weight-bold font-bold text-lg-right pt-2">Payment
                                                        Date<span class="mandfield text-2 ml-1"><sup>*</sup></span>
                                                    </label>
                                                    <input [(ngModel)]="paymentData.txnDate" name="txnDate" type="text" placeholder="yyyy/mm/dd" (click)="txDnate.toggle()"
                                                        ngbDatepicker #txDnate="ngbDatepicker" class="form-control" autocomplete="off" [minDate]="dateMinLimit" [maxDate]="futureDatesLimit" #txnDate="ngModel" required>
                                                    <div *ngIf="txnDate.invalid && (txnDate.dirty || txnDate.touched)" class="text-danger">
                                                        <div *ngIf="txnDate.errors.required">
                                                            Payment date is required.
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-5 offset-lg-1">
                                            <div class="row" id="settlementListDiv">
                                                <div class="col-lg-10">
                                                    <label
                                                        class="control-label font-weight-bold font-bold text-lg-right pt-2">Payment# <span class="mandfield text-2 ml-1"><sup>*</sup></span>
                                                    </label>
                                                    <input [(ngModel)]="paymentData.paymentNo" name="paymentNo" type="text" class="form-control" #payNum="ngModel" required placeholder="eg. 1254A">
                                                    <div *ngIf="payNum.invalid && (payNum.dirty || payNum.touched)" class="text-danger">
                                                        <div *ngIf="payNum.errors.required">
                                                            Payment date is required.
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="row" *ngIf="lastExist">
                                        <div class="col-lg-12">
                                            <h4>Last Payments</h4>
                                        </div>
                                    </div>

                                    <!-- Employee PAYMENT DIV -->
                                    <div id="employeePaymentDiv">
                                        <div class="row" *ngIf="lastExist">
                                            <div class="col-lg-10 offset-lg-1">
                                                <table class="table table-bordered table-striped mb-0 simple-table">
                                                    <thead>
                                                        <tr class="bgcol2">
                                                            <th class="text-2">Payment#/Date</th>
                                                            <th class="text-2">Payment Mode Information</th>
                                                            <th class="text-2">Employee Information</th>
                                                            <th class="text-2">Amount</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>{{ lastAdded.paymentNo }}<br>{{ lastAdded.txnDate | date: "yyyy/MM/dd" }}</td>
                                                            <td>{{ lastAdded.payMode }}<br>Ref.#
                                                                :<strong>{{ lastAdded.payModeNo }}</strong><br>Date:<strong>{{ lastAdded.payModeDate | date: "yyyy/MM/dd" }}</strong>
                                                            </td>
                                                            <td>Name: <strong>{{ empdetail.firstName }} {{ empdetail.lastName }}</strong>
                                                                <br>Department: <strong>{{ (empdetail.userAccount.department) ? empdetail.userAccount.department : '-' }}</strong>
                                                                <br>Designation:<strong>{{ (empdetail.userAccount.designation) ? empdetail.userAccount.designation : '-' }}</strong>
                                                            </td>
                                                            <td>Total Amount: 
                                                                <strong>{{ lastAdded.finalTotal }} CAD</strong>
                                                                <br>Add:&nbsp;
                                                                <strong>{{ lastAdded.additionTotal }} CAD</strong>
                                                                &nbsp;&nbsp;Deduct:&nbsp;
                                                                <strong>{{ lastAdded.deductionTotal }} CAD</strong>
                                                                <br>Taxes:<strong>{{ lastAdded.taxes }} CAD </strong>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="row pt-2">
                                            <div class="col-lg-12">
                                                <h4>Payment Information</h4>
                                            </div>
                                        </div>
                                        <div class="row pt-2">
                                            <div class="col-lg-10 offset-lg-1">
                                                <div class="row">
                                                    <div class="col-lg-3">
                                                        <label
                                                            class="control-label font-weight-bold font-bold text-lg-right pt-2">Payroll Type<span class="mandfield text-2 ml-1"><sup>*</sup></span>
                                                        </label>
                                                        <ng-select [(ngModel)]="paymentData.payroll.type" name="payrollType" placeholder="Select Payroll Type" disabled>
                                                            <ng-option value="flat">Flat</ng-option>
                                                            <ng-option value="hourly">Hours</ng-option>
                                                        </ng-select>
                                                    </div>
                                                    <div id="payrollHourDiv" style="display: flex;" *ngIf="paymentData.payroll.type === 'hourly'">
                                                        <div class="col-lg-3">
                                                            <label
                                                                class="control-label font-weight-bold font-bold text-lg-right pt-2">Hours<span class="mandfield text-2 ml-1"><sup>*</sup></span>
                                                            </label>
                                                            <input type="text" class="form-control" name="hours" [(ngModel)]="paymentData.payroll.hours" (change)="EmpRateCalc()" placeholder="e.g 8" #rllHOur="ngModel" required>
                                                            <div *ngIf="rllHOur.invalid && (rllHOur.dirty || rllHOur.touched)" class="text-danger">
                                                                <div *ngIf="rllHOur.errors.required">
                                                                    Hours are required.
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <label
                                                                class="control-label font-weight-bold font-bold text-lg-right pt-2">Rate/Hour<span class="mandfield text-2 ml-1"><sup>*</sup></span>
                                                            </label>
                                                            <input type="text" class="form-control" name="perHour" [(ngModel)]="paymentData.payroll.perHour" placeholder="e.g 10" disabled #hourRate="ngModel" required>
                                                            <div *ngIf="hourRate.invalid && (hourRate.dirty || hourRate.touched)" class="text-danger">
                                                                <div *ngIf="hourRate.errors.required">
                                                                    Rate/Hour is required.
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div id="payrollFlatDiv" *ngIf="paymentData.payroll.type === 'flat'">
                                                        <div class="col-lg-8">
                                                            <label
                                                                class="control-label font-weight-bold font-bold text-lg-right pt-2">Flat
                                                                Amount<span class="mandfield text-2 ml-1"><sup>*</sup></span>
                                                            </label>
                                                            <input type="text" class="form-control" name="amount" [(ngModel)]="paymentData.payroll.amount" placeholder="e.g 50" disabled #flAmount="ngModel" required>
                                                            <div *ngIf="flAmount.invalid && (flAmount.dirty || flAmount.touched)" class="text-danger">
                                                                <div *ngIf="flAmount.errors.required">
                                                                    Flat amount is required.
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row pt-2">
                                            <div class="col-lg-10 offset-lg-1">
                                                <h4 class="font-weight-bold">Addition</h4>
                                            </div>
                                            <div class="col-lg-10 offset-lg-1">
                                                <table class="table table-bordered" id="otherChargesTable">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Charge Name</th>
                                                            <th>Description</th>
                                                            <th>Amount</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr *ngFor="let data of paymentData.addition; let i=index;">
                                                            <td>{{ data.eventDate }}</td>
                                                            <td>{{ data.chargeName }}</td>
                                                            <td>{{ data.desc }}</td>
                                                            <td>{{ data.amount }} {{ data.currency }}</td>
                                                            <td>
                                                                <span class="badge badge-dark p-2" (click)="delRow(i, 'additional')"><i class="fas fa-trash-alt text-light"></i></span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <input [(ngModel)]="additionRowData.eventDate" name="setDate" type="text" placeholder="yyyy/mm/dd" (click)="setDate.toggle()"
                                                                ngbDatepicker #setDate="ngbDatepicker" class="form-control" autocomplete="off" [minDate]="dateMinLimit" [maxDate]="futureDatesLimit">
                                                            </td>
                                                            <td>
                                                                <input type="text" class="form-control" [(ngModel)]="additionRowData.chargeName" name="addChargeName" placeholder="Enter charge name">
                                                            </td>
                                                            <td>
                                                                <input type="text" class="form-control" [(ngModel)]="additionRowData.desc" name="adDescription" placeholder="Enter description">
                                                            </td>
                                                            <td>
                                                                <input type="text" class="form-control" [(ngModel)]="additionRowData.amount" name="adAmount" placeholder="Enter amount">
                                                            </td>
                                                            <td>
                                                                <button type="button" class="btn btn-success btn-sm" (click)="addAdditionalExp()"><i class="fas fa-plus"></i> Add</button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <div class="row">
                                                    <div class="col-lg-3 offset-lg-8 pr-5">
                                                        <div class="row">
                                                            <div class="col-lg-6 text-right"><label
                                                                    class="control-label font-weight-bold">Total
                                                                    Addition</label></div>
                                                            <div class="col-lg-6">
                                                                <input type="text" class="form-control" name="additionTotal" [(ngModel)]="paymentData.additionTotal" placeholder="e.g 150" disabled>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-1 text-right">

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-10 offset-lg-1">
                                                <h4 class="font-weight-bold">Deduction</h4>
                                            </div>
                                            <div class="col-lg-10 offset-lg-1">
                                                <table class="table table-bordered" id="otherChargesTable">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Charge Name</th>
                                                            <th>Description</th>
                                                            <th>Amount</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr *ngFor="let data of paymentData.deduction; let i=index;">
                                                            <td>{{ data.eventDate }}</td>
                                                            <td>{{ data.chargeName }}</td>
                                                            <td>{{ data.desc }}</td>
                                                            <td>{{ data.amount }} {{ data.currency }}</td>
                                                            <td>
                                                                <span class="badge badge-dark p-2" (click)="delRow(i, 'deduction')"><i class="fas fa-trash-alt text-light"></i></span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <input [(ngModel)]="deductionRowData.eventDate" name="dedDate" type="text" placeholder="yyyy/mm/dd" (click)="dedDate.toggle()"
                                                                ngbDatepicker #dedDate="ngbDatepicker" class="form-control" autocomplete="off" [minDate]="dateMinLimit" [maxDate]="futureDatesLimit">
                                                            </td>
                                                            <td>
                                                                <input type="text" class="form-control" [(ngModel)]="deductionRowData.chargeName" name="dedChargeName" placeholder="Enter charge name">
                                                            </td>
                                                            <td>
                                                                <input type="text" class="form-control" [(ngModel)]="deductionRowData.desc" name="dedDescription" placeholder="Enter description">
                                                            </td>
                                                            <td>
                                                                <input type="text" class="form-control" [(ngModel)]="deductionRowData.amount" name="dedAmount" placeholder="Enter amount">
                                                            </td>
                                                            <td>
                                                                <button type="button" class="btn btn-success btn-sm" (click)="adddeductionExp()"><i class="fas fa-plus"></i> Add</button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <div class="row">
                                                    <div class="col-lg-3 offset-lg-8 pr-5">
                                                        <div class="row">
                                                            <div class="col-lg-6 text-right"><label
                                                                    class="control-label font-weight-bold">Total
                                                                    Deduction</label></div>
                                                            <div class="col-lg-6">
                                                                <input type="text" class="form-control" name="deductionTotal" [(ngModel)]="paymentData.deductionTotal" placeholder="e.g 150" disabled>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-1 text-right">

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row pt-2">
                                            <div class="col-lg-5 offset-lg-1">
                                                <div class="row">
                                                    <div class="col-lg-5">
                                                        <label class="control-label font-weight-bold">Select Account<span class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                                                        <ng-select [(ngModel)]="paymentData.accountID" name="accountID" placeholder="Select Account" #accountID="ngModel" required>
                                                            <ng-option value="{{ data.actID }}" *ngFor="let data of accounts | async">{{ data.actName }} - {{
                                                                data.actNo }}</ng-option>
                                                        </ng-select>

                                                        <div *ngIf="accountID.invalid && (accountID.dirty || accountID.touched)" class="text-danger">
                                                            <div *ngIf="accountID.errors.required">
                                                                Account is required.
                                                            </div>
                                                        </div>
                                                    </div>
                                                
                                                    <div class="col-lg-5"><label
                                                            class="control-label font-weight-bold labelalign">Payment
                                                            Mode<span class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                                                        <ng-select [(ngModel)]="paymentData.payMode" name="payMode"
                                                            placeholder="Select Payment Mode" (change)="changePaymentMode($event)" #payMode="ngModel" required>
                                                            <ng-option value="cash">Cash</ng-option>
                                                            <ng-option value="cheque">Cheque</ng-option>
                                                            <ng-option value="eft">EFT</ng-option>
                                                            <ng-option value="credit_card">Credit Card</ng-option>
                                                            <ng-option value="debit_card">Debit Card</ng-option>
                                                            <ng-option value="demand_draft">Demand Draft</ng-option>
                                                        </ng-select>

                                                        <div *ngIf="payMode.invalid && (payMode.dirty || payMode.touched)" class="text-danger">
                                                            <div *ngIf="payMode.errors.required">
                                                                Payment mode is required.
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-5"></div>
                                                </div>
                                                <div class="row pt-1" id="chequeDivDriver" *ngIf="paymentData.payMode">
                                                    <div class="col-lg-5">
                                                        <label class="control-label font-weight-bold labelalign">{{ payModeLabel }} Number<span class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                                                        <input type="text" class="form-control" [(ngModel)]="paymentData.payModeNo" name="payModeNo" placeholder="{{ payModeLabel }} Number" #payNoo="ngModel" required>
                                                        <div *ngIf="payNoo.invalid && (payNoo.dirty || payNoo.touched)" class="text-danger">
                                                            <div *ngIf="payNoo.errors.required">
                                                                {{ payModeLabel }} Number is required.
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-5">
                                                        <label class="control-label font-weight-bold labelalign">{{ payModeLabel }} Date<span class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                                                        <input [(ngModel)]="paymentData.payModeDate" name="payModeDate" type="text"
                                                            placeholder="yyyy/mm/dd" (click)="payModeDate.toggle()" ngbDatepicker
                                                            #payModeDate="ngbDatepicker" class="form-control" autocomplete="off"
                                                            [minDate]="dateMinLimit" [maxDate]="futureDatesLimit" #payDate="ngModel" required>

                                                        <div *ngIf="payDate.invalid && (payDate.dirty || payDate.touched)" class="text-danger">
                                                            <div *ngIf="payDate.errors.required">
                                                                {{ payModeLabel }} Date is required.
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 offset-lg-2">
                                                <div class="row">
                                                    <div class="col-lg-6 text-right"><label
                                                            class="control-label font-weight-bold">
                                                            Amount</label></div>
                                                    <div class="col-lg-6">
                                                        <input type="text" class="form-control" name="paymentTotal" [(ngModel)]="paymentData.paymentTotal" placeholder="e.g 150" disabled>
                                                    </div>
                                                </div>
                                                <div class="row pt-1">
                                                    <div class="col-lg-6 text-right">
                                                        <label class="control-label font-weight-bold">Other
                                                            Charges</label></div>
                                                </div>
                                                <div class="row pt-1">
                                                    <div class="col-lg-6 text-right">
                                                        <label class="control-label font-weight-bold">Add</label>
                                                    </div>
                                                    <div class="col-lg-6">
                                                        <input type="text" class="form-control" name="aitionTotal" [(ngModel)]="paymentData.additionTotal" placeholder="e.g 150" disabled>
                                                    </div>
                                                </div>
                                                <div class="row pt-1">
                                                    <div class="col-lg-6 text-right"><label
                                                            class="control-label font-weight-bold">Deduct</label>
                                                    </div>
                                                    <div class="col-lg-6">
                                                        <input type="text" class="form-control" name="dedddd" [(ngModel)]="paymentData.deductionTotal" placeholder="e.g 150" disabled>
                                                    </div>
                                                    <div class="col-lg-6 offset-lg-6 pt-2"><a href="javascript:;"
                                                            class="btn btn-default modal-with-form btn-sm">Calculate
                                                            Payroll</a></div>
                                                </div>
                                                <div class="row pt-1">
                                                    <div class="col-lg-6 text-right"><label
                                                            class="control-label font-weight-bold">Taxes</label>
                                                    </div>
                                                    <div class="col-lg-6">
                                                        <input type="text" class="form-control" name="taxes" [(ngModel)]="paymentData.taxes" placeholder="e.g 150" (input)="calculateFinalTotal(); checkInput('tax')">
                                                        <label class="error">{{ taxErr }}</label>
                                                    </div>
                                                </div>
                                                <div class="row pt-1">
                                                    <div class="col-lg-6 text-right"><label
                                                            class="control-label font-weight-bold">Advance</label>
                                                    </div>
                                                    <div class="col-lg-6">
                                                        <input type="text" class="form-control" name="advance" [(ngModel)]="paymentData.advance" placeholder="e.g 150" (input)="calculateFinalTotal(); checkInput('advance');">
                                                        <label class="error">{{ advErr }}</label>
                                                    </div>
                                                </div>
                                                <div class="row pt-1">
                                                    <div class="col-lg-6 text-right"><label
                                                            class="control-label font-weight-bold">Net
                                                            Payable</label></div>
                                                    <div class="col-lg-6">
                                                        <input type="text" class="form-control" name="finalTotal" [(ngModel)]="paymentData.finalTotal" placeholder="e.g 150" disabled>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group row mt-4">
                                        <div class="col-lg-11 text-right">
                                            <button type="button" class="btn btn-default mr-2" routerLink="">Cancel</button>
                                            <button class="btn btn-success" (click)="addRecord()" [disabled]="!empPaymentForm.form.valid || submitDisabled" *ngIf="!paymentID">Save</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </section>
    </div>
</section>