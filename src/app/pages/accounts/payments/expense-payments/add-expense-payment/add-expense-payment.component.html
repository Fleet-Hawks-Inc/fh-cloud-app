<section class="body">
  <div class="inner-wrapper">
    <section role="main" class="content-body pl-0 pr-0 pt-0">
      <header class="page-header pr19 pl7">
        <div class="row" style="padding-top: 10px">
          <div class="col-md-4 col-lg-4">
            <h4 class="text-4 mt-0 mb-0 font-weight-bold text-dark">Payment</h4>
          </div>
          <div class="col-md-8 col-lg-8 text-right pr-1">
            <a routerLink="/accounts/payments/expense-payments/list" class="btn btn-default btn-sm"><i
                class="fas fa-list"></i> All Payments</a>
          </div>
        </div>
      </header>

      <section class="m-2">
        <form class="form-horizontal form-bordered" method="get" #paymentForm="ngForm">
          <div class="row mb-3">
            <div class="col-lg-12">
              <div class="bg-white p-3 text-dark">
                <div class="form-group row adddriverpl pt-3">
                  <div class="col-lg-6">
                    <div class="row" id="settlementListDiv">
                      <div class="col-lg-10">
                        <label class="control-label font-weight-bold font-bold text-lg-right pt-2">Pay To
                          <span class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                        <ng-select [(ngModel)]="paymentData.paymentTo" name="pamentTo" placeholder="Select type"
                          #paymenttTO="ngModel" required (change)="getEntityData($event)">
                          <ng-option value="driver">Driver</ng-option>
                          <ng-option value="carrier">Carrier</ng-option>
                          <ng-option value="owner_operator">Owner Operator</ng-option>
                        </ng-select>

                        <div *ngIf="
                            paymenttTO.invalid &&
                            (paymenttTO.dirty || paymenttTO.touched)
                          " class="text-danger">
                          <div *ngIf="paymenttTO.errors.required">
                            Pay To is required.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-6">
                    <div class="row" id="settlementListDiv">
                      <div class="col-lg-5">
                        <label class="control-label font-weight-bold font-bold text-lg-right pt-2">Payment Date<span
                            class="mandfield text-2 ml-1"><sup>*</sup></span>
                        </label>
                        <input [(ngModel)]="paymentData.txnDate" name="txnDate" type="text" placeholder="yyyy/mm/dd"
                          (click)="txnDate.toggle()" ngbDatepicker #txnDate="ngbDatepicker" class="form-control"
                          autocomplete="off" [minDate]="dateMinLimit" [maxDate]="futureDatesLimit" #paymntDate="ngModel"
                          required readonly />
                        <div *ngIf="
                            paymntDate.invalid &&
                            (paymntDate.dirty || paymntDate.touched)
                          " class="text-danger">
                          <div *ngIf="paymntDate.errors.required">
                            Payment date is required.
                          </div>
                        </div>
                      </div>
                      <div class="col-lg-5">
                        <label class="control-label font-weight-bold font-bold text-lg-right pt-2">Payment Currency<span
                            class="mandfield text-2 ml-1"><sup>*</sup></span>
                        </label>
                        <ng-select [(ngModel)]="paymentData.currency" name="payCurr" placeholder="Select
                                                    Currency" #paymentCurr="ngModel" required [clearable]="false">
                          <ng-option value="CAD">CAD</ng-option>
                          <ng-option value="USD">USD</ng-option>
                        </ng-select>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-group row adddriverpl pt-3" *ngIf="paymentData.paymentTo">
                  <div class="col-lg-6">
                    <div class="row" id="driverListDiv" *ngIf="paymentData.paymentTo === 'driver'">
                      <div class="col-lg-10">
                        <label class="control-label font-weight-bold font-bold text-lg-right pt-2">Select Driver<span
                            class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                        <ng-select [(ngModel)]="paymentData.entityId" name="type" placeholder="Select Driver"
                          #driverID="ngModel" required class="text-capitalize" (change)="emptyPrevSelection()">
                          <ng-option value="{{ data.driverID }}" *ngFor="let data of drivers">{{ data.firstName }} {{
                            data.lastName }}
                          </ng-option>
                        </ng-select>

                        <div *ngIf="
                            driverID.invalid &&
                            (driverID.dirty || driverID.touched)
                          " class="text-danger">
                          <div *ngIf="driverID.errors.required">
                            Driver is required.
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row" id="carrierListDiv" *ngIf="paymentData.paymentTo === 'carrier'">
                      <div class="col-lg-10">
                        <label class="control-label font-weight-bold font-bold text-lg-right pt-2">Select Carrier<span
                            class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                        <ng-select [(ngModel)]="paymentData.entityId" name="type" placeholder="Select Carrier"
                          #carrID="ngModel" required class="text-capitalize" (change)="emptyPrevSelection()">
                          <ng-option value="{{ data.contactID }}" *ngFor="let data of carriers">{{ data.companyName }}
                          </ng-option>
                        </ng-select>

                        <div *ngIf="
                            carrID.invalid && (carrID.dirty || carrID.touched)
                          " class="text-danger">
                          <div *ngIf="carrID.errors.required">
                            Carrier is required.
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row" id="ownerOperatorListDiv" *ngIf="paymentData.paymentTo === 'owner_operator'">
                      <div class="col-lg-10">
                        <label class="control-label font-weight-bold font-bold text-lg-right pt-2">
                          Select Owner Operator<span class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                        <ng-select [(ngModel)]="paymentData.entityId" name="type" placeholder="Select Owner
                                                    Operator" #oprID="ngModel" required class="text-capitalize"
                          (change)="emptyPrevSelection()">
                          <ng-option value="{{ data.contactID }}" *ngFor="let data of ownerOperators">{{
                            data.companyName }}
                          </ng-option>
                        </ng-select>

                        <div *ngIf="
                            oprID.invalid && (oprID.dirty || oprID.touched)
                          " class="text-danger">
                          <div *ngIf="oprID.errors.required">
                            Owner operator is required.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-2">
                    <label class="control-label font-weight-bold pt-2">From Date<span
                        class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                    <input [(ngModel)]="paymentData.fromDate" name="fromDate" type="text" placeholder="yyyy/mm/dd"
                      (click)="fromDate.toggle()" ngbDatepicker #fromDate="ngbDatepicker" class="form-control"
                      autocomplete="off" [minDate]="dateMinLimit" [maxDate]="futureDatesLimit" #fDate="ngModel" />
                    <div *ngIf="fDate.invalid && (fDate.dirty || fDate.touched)" class="text-danger">
                      <div *ngIf="fDate.errors.required">
                        From date is required.
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-2">
                    <label class="control-label font-weight-bold pt-2">To Date<span
                        class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                    <input [(ngModel)]="paymentData.toDate" name="toDate" type="text" placeholder="yyyy/mm/dd"
                      (click)="toDate.toggle()" ngbDatepicker #toDate="ngbDatepicker" class="form-control"
                      autocomplete="off" [minDate]="dateMinLimit" [maxDate]="futureDatesLimit" #EDate="ngModel" />
                    <div *ngIf="EDate.invalid && (EDate.dirty || EDate.touched)" class="text-danger">
                      <div *ngIf="EDate.errors.required">
                        To date is required.
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-1 text-right">
                    <button class="btn btn-sm btn-success mar-top-37" [disabled]="searchDisabled"
                      (click)="fetchSearchData()">
                      Search
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="driverPaymentDiv" style="display: block">
            <div class="row mb-3">
              <div class="col-lg-12">
                <div class="bg-white p-3 text-dark">
                  <div class="form-group row">
                    <div class="col-lg-12">
                      <label
                        class="control-label font-weight-bold font-weight-bold text-lg-right text-5">Settlements</label>
                    </div>
                    <div class="col-lg-12">
                      <table class="table table-bordered table-responsive-lg table-striped simple-table">
                        <thead>
                          <tr class="bgcol2">
                            <th></th>
                            <th class="text-2">Settlement#</th>
                            <th class="text-2">Settlement Date</th>
                            <th class="text-2">Trip#</th>
                            <th class="text-2">Amount</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngIf="settlements.length === 0" class="text-center">
                            <td colspan="11">{{ dataMessage }}</td>
                          </tr>
                          <tr *ngFor="let data of settlements; let i = index">
                            <td>
                              <input type="checkbox" name="stl{{ i }}" [(ngModel)]="data.selected"
                                (change)="selectedSettlements()" />
                            </td>
                            <td>{{ data.setNo }}</td>
                            <td>{{ data.txnDate | date: "yyyy/MM/dd" }}</td>
                            <td>
                              {{ data.tripNo }}
                            </td>
                            <td>
                              {{ data.finalTotal | number: "1.2-2" }}
                              {{ data.currency }}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-lg-12">
                <div class="bg-white p-3 text-dark">
                  <div class="form-group row">
                    <div class="col-lg-12">
                      <label class="control-label font-weight-bold font-weight-bold text-lg-right text-5">Advance
                        Payments</label>
                    </div>
                    <div class="col-lg-12">
                      <table class="table table-bordered table-responsive-lg table-striped simple-table">
                        <thead>
                          <tr class="bgcol2">
                            <th></th>
                            <th class="text-2">Payment#</th>
                            <th class="text-2">Advance Type</th>
                            <th class="text-2">Payment Date</th>
                            <th class="text-2">Account#</th>
                            <th class="text-2">Total Amount</th>
                            <th class="text-2">Pending Amount</th>
                            <th class="text-2">Paid Amount</th>
                            <th class="text-2">Status</th>
                            <th class="text-2">Full Payment</th>
                            <th class="text-2">Payment</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngIf="advancePayments.length === 0" class="text-center">
                            <td colspan="11">{{ dataMessageAdv }}</td>
                          </tr>
                          <tr *ngFor="let data of advancePayments; let i = index">
                            <td>
                              <input type="checkbox" name="stl{{ i }}" [(ngModel)]="data.selected"
                                (change)="selectedAdvancepayments()" />
                            </td>
                            <td>{{ data.paymentNo }}</td>
                            <td class="text-capitalize">
                              {{ data.advType }}
                            </td>
                            <td>{{ data.txnDate | date: "yyyy/MM/dd" }}</td>
                            <td>{{ accList[data.accountID] }}</td>
                            <td>
                              {{ data.amount | number: "1.2-2" }}
                              {{ data.currency }}
                            </td>
                            <td>
                              {{ data.pendingPayment | number: "1.2-2" }}
                              {{ data.currency }}
                            </td>
                            <td>{{ data.prevPaidAmount | number: "1.2-2" }}</td>
                            <td>
                              <span class="badge badge-dark p-1 text-uppercase">{{ data.status }}</span>
                            </td>
                            <td class="text-center">
                              <input type="checkbox" [(ngModel)]="data.fullPayment" name="advfinal{{ i }}"
                                (change)="assignFullPayment('advance', i, data)" />
                            </td>
                            <td>
                              <input type="text" class="form-control" [(ngModel)]="data.paidAmount" (input)="
                                  selectedAdvancepayments();
                                  checkInput('advance', i)
                                " name="advPaidAmount{{ i }}" [disabled]="data.paidStatus" />
                              <label id="stlErr{{ i }}" class="error">{{
                                data.errText
                                }}</label>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-lg-12">
                <div class="bg-white p-3 text-dark">
                  <div class="form-group row">
                    <div class="col-lg-12">
                      <label class="control-label font-weight-bold font-weight-bold text-lg-right text-5">Expense
                        Payments</label>
                    </div>
                    <div class="col-lg-12">
                      <table class="table table-bordered table-responsive-lg table-striped simple-table">
                        <thead>
                          <tr class="bgcol2">
                            <th></th>
                            <th class="text-2">Expense Date</th>
                            <th class="text-2">Category</th>
                            <th class="text-2">Trip#</th>
                            <th class="text-2">Total Amount</th>
                            <th class="text-2">Pending Amount</th>
                            <th class="text-2">Paid Amount</th>
                            <th class="text-2">Status</th>
                            <th class="text-2">Full Payment</th>
                            <th class="text-2">Payment</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngIf="expenses.length === 0" class="text-center">
                            <td colspan="11">{{ dataMessageExp }}</td>
                          </tr>
                          <tr *ngFor="let data of expenses; let i = index">
                            <td>
                              <input type="checkbox" name="exp{{ i }}" [(ngModel)]="data.selected"
                                (change)="selectedExpenses()" />
                            </td>
                            <td>{{ data.txnDate | date: "yyyy/MM/dd" }}</td>
                            <td>
                              {{ data.catName }}
                            </td>
                            <td>
                              {{ data.tripNo }}
                            </td>
                            <td>
                              {{ data.finalTotal | number: "1.2-2" }}
                              {{ data.currency }}
                            </td>
                            <td>
                              {{ data.balance | number: "1.2-2" }}
                              {{ data.currency }}
                            </td>
                            <td>{{ data.prevPaidAmount | number: "1.2-2" }}</td>
                            <td>
                              <span class="badge badge-dark p-1 text-uppercase">{{ data.status }}</span>
                            </td>
                            <td class="text-center">
                              <input type="checkbox" [(ngModel)]="data.fullPayment" name="advfinal{{ i }}"
                                (change)="assignFullPayment('expense', i, data)" />
                            </td>
                            <td>
                              <input type="text" class="form-control" [(ngModel)]="data.paidAmount" (input)="
                                  selectedExpenses(); checkInput('expense', i)
                                " name="expensePaidAmount{{ i }}" [disabled]="data.paidStatus" />
                              <label id="expErr{{ i }}" class="error">{{
                                data.errText
                                }}</label>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-lg-12">
                <div class="bg-white p-3 text-dark">
                  <div class="form-group row adddriverpl pt-3">
                    <div class="col-lg-12">
                      <label class="control-label font-weight-bold font-weight-bold text-lg-right text-5">Settlement
                        Information</label>
                    </div>

                    <div class="col-lg-6">
                      <div class="row pt-1">
                        <div class="col-lg-5">
                          <label class="control-label font-weight-bold labelalign">Payment Mode<span
                              class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                          <ng-select [(ngModel)]="paymentData.payMode" name="payMode" placeholder="Select
                                                        Payment Mode" (change)="changePaymentMode($event)"
                            #payMode="ngModel" required>
                            <ng-option value="cash">Cash</ng-option>
                            <ng-option value="cheque">Cheque</ng-option>
                            <ng-option value="eft">EFT</ng-option>
                            <ng-option value="credit_card">Credit Card</ng-option>
                            <ng-option value="debit_card">Debit Card</ng-option>
                            <ng-option value="demand_draft">Demand Draft</ng-option>
                          </ng-select>

                          <div *ngIf="
                              payMode.invalid &&
                              (payMode.dirty || payMode.touched)
                            " class="text-danger">
                            <div *ngIf="payMode.errors.required">
                              Payment mode is required.
                            </div>
                          </div>
                        </div>
                        <div class="col-lg-5">
                          <label class="control-label font-weight-bold">Select Account<span
                              class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                          <ng-select [(ngModel)]="paymentData.accountID" name="accountID" placeholder="Select
                                                        Account" #accountID="ngModel" required>
                            <ng-option value="{{ data.key }}" *ngFor="let data of accList | keyvalue">{{ data.value }}
                            </ng-option>
                          </ng-select>
                          <div *ngIf="
                              accountID.invalid &&
                              (accountID.dirty || accountID.touched)
                            " class="text-danger">
                            <div *ngIf="accountID.errors.required">
                              Account is required.
                            </div>
                          </div>
                        </div>
                        <div class="col-lg-2" style="margin-top: 32px">
                          <!-- <a href="javascript:;" (click)="refreshAccount()"
                                                        data-toggle="tooltip" title="Refresh account
                                                        data" class="btn btn-success
                                                        btn-sm modal-with-form"><i class="fas fa-sync"></i></a> -->
                        </div>
                      </div>
                      <div class="row pt-1" *ngIf="
                          paymentData.payMode &&
                          paymentData.payMode !== 'cheque'
                        ">
                        <div class="col-lg-5">
                          <label class="control-label font-weight-bold labelalign">{{ payModeLabel }} Reference<span
                              class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                          <input type="text" class="form-control" [(ngModel)]="paymentData.payModeNo" name="payModeNo"
                            placeholder="{{ payModeLabel }}
                                                        Reference" #modeNo="ngModel" [required]="
                              paymentData.payMode &&
                              paymentData.payMode !== 'cheque'
                            " pattern="^[a-zA-Z0-9\s]+$" />
                          <div *ngIf="
                              modeNo.invalid && (modeNo.dirty || modeNo.touched)
                            " class="text-danger">
                            <div *ngIf="modeNo.errors.required">
                              {{ payModeLabel }}
                              Reference is required.
                            </div>
                            <div *ngIf="modeNo.errors.pattern">
                              {{ payModeLabel }}
                              Reference must contain alphanumeric characters.
                            </div>
                          </div>
                        </div>
                        <div class="col-lg-5">
                          <label class="control-label font-weight-bold labelalign">{{ payModeLabel }} Date<span
                              class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                          <input [(ngModel)]="paymentData.payModeDate" name="payModeDate" type="text"
                            placeholder="yyyy/mm/dd" (click)="payModeDate.toggle()" ngbDatepicker
                            #payModeDate="ngbDatepicker" class="form-control" autocomplete="off"
                            [minDate]="dateMinLimit" [maxDate]="futureDatesLimit" #modeDate="ngModel" required />
                          <div *ngIf="
                              modeDate.invalid &&
                              (modeDate.dirty || modeDate.touched)
                            " class="text-danger">
                            <div *ngIf="modeDate.errors.required">
                              {{ payModeLabel }}
                              date is required.
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row pt-1" id="chequeDivDriver" *ngIf="
                          paymentData.payMode &&
                          paymentData.payMode === 'cheque'
                        ">
                        <div class="col-lg-5">
                          <label class="control-label font-weight-bold labelalign">{{ payModeLabel }} Reference<span
                              class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                          <input type="text" class="form-control" placeholder="hello"
                            [(ngModel)]="paymentData.payModeNo" name="payModeNo" placeholder="{{ payModeLabel }}
                                                        Reference" />
                        </div>
                        <div class="col-lg-5">
                          <label class="control-label font-weight-bold labelalign">{{ payModeLabel }} Date<span
                              class="mandfield text-2 ml-1"><sup>*</sup></span></label>
                          <input [(ngModel)]="paymentData.payModeDate" name="payModeDate" type="text"
                            placeholder="yyyy/mm/dd" (click)="payModeDate.toggle()" ngbDatepicker
                            #payModeDate="ngbDatepicker" class="form-control" autocomplete="off"
                            [minDate]="dateMinLimit" [maxDate]="futureDatesLimit" #payDate="ngModel" required />
                          <div *ngIf="
                              payDate.invalid &&
                              (payDate.dirty || payDate.touched)
                            " class="text-danger">
                            <div *ngIf="payDate.errors.required">
                              {{ payModeLabel }}
                              Date is required.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-3 offset-lg-2">
                      <div class="row pt-1">
                        <div class="col-lg-6 text-right">
                          <label class="control-label font-weight-bold">Advance</label>
                        </div>
                        <div class="col-lg-6">
                          <input type="text" class="form-control" [(ngModel)]="paymentData.advTotal" name="advTotal"
                            disabled />
                        </div>
                      </div>
                      <div class="row pt-1">
                        <div class="col-lg-6 text-right">
                          <label class="control-label font-weight-bold">Expense</label>
                        </div>
                        <div class="col-lg-6">
                          <input type="text" class="form-control" [(ngModel)]="paymentData.expTotal" name="expTotal"
                            (input)="
                              paymentCalculation(); checkInput('expense')
                            " disabled />
                        </div>
                      </div>
                      <div class="row pt-1">
                        <div class="col-lg-6 text-right">
                          <label class="control-label font-weight-bold">Net Payable</label>
                        </div>
                        <div class="col-lg-6">
                          <input type="text" class="form-control" [(ngModel)]="paymentData.finalAmount"
                            name="finalAmount" disabled />

                          <label class="error">{{ expErr }}</label>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="form-group row mt-4">
                    <div class="col-lg-11 pr-0 text-right">
                      <button type="button" class="btn btn-default mr-2" (click)="cancel()">
                        Cancel
                      </button>
                      <button type="button" [disabled]="paymentData.expTotal == 0"
                        class="btn btn-success modal-with-form mr-2" *ngIf="
                          paymentData.payMode == 'cheque'
                        " (click)="showCheque()">
                        Cheque preview
                      </button>
                      <button type="button" class="btn btn-success modal-with-form"
                        [disabled]="!paymentForm.form.valid || submitDisabled" (click)="addRecord()">
                        Save
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </section>
    </section>
  </div>
</section>
<app-payment-cheque></app-payment-cheque>